<% content_for :page_js do %>
  <script type="module">
    import "booking_form"
  </script>
<% end %>

<div class="container-fluid py-4">
  <div class="row g-4">

    <!-- ================= LEFT: BOOKING FORM ================= -->
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">

          <h3 class="mb-4">New Booking</h3>

          <%= form_with(model: booking, class: "needs-validation") do |form| %>

            <% if booking.errors.any? %>
              <div class="alert alert-danger">
                <ul class="mb-0">
                  <% booking.errors.each do |error| %>
                    <li><%= error.full_message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <!-- Stay Duration -->
            <div class="mb-4">
              <h5 class="mb-3">Stay Duration</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label :check_in, "Check In", class: "form-label" %>
                  <%= form.datetime_field :check_in, required: true, class: "form-control" %>
                </div>

                <div class="col-md-6 mb-3">
                  <%= form.label :check_out, "Check Out", class: "form-label" %>
                  <%= form.datetime_field :check_out, required: true, class: "form-control" %>
                </div>
              </div>
            </div>

            <!-- Room -->
            <div class="mb-4">
              <h5 class="mb-3">Room</h5>

              <%= form.label :room_id, "Available Rooms", class: "form-label" %>

              <div class="d-flex align-items-center gap-3">
                <%= form.collection_select :room_id, [], :id, :room_number,
                      { include_blank: "Select dates first" },
                      { required: true, disabled: true, class: "form-select" } %>

                <div id="room-status" class="fw-semibold text-muted"></div>
              </div>
            </div>

            <!-- Customer -->
            <div class="mb-4">
              <h5 class="mb-3">Customer</h5>

              <div class="position-relative">
                <input
                  type="text"
                  id="customer_search"
                  placeholder="Search by name or phone"
                  autocomplete="off"
                  class="form-control"
                  required
                >

                <div id="customer-results"
                     class="list-group position-absolute w-100 shadow"
                     style="z-index: 1000;">
                </div>
              </div>

              <%= form.hidden_field :customer_id, id: "booking_customer_id", required: true %>

              <div class="mt-3">
                <%= link_to "Add New Customer",
                      new_customer_path,
                      target: "_blank",
                      class: "btn btn-outline-secondary btn-sm" %>
              </div>
            </div>

            <!-- Guests -->
            <div class="mb-4">
              <h5 class="mb-3">Guests</h5>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label :adults, "Adults", class: "form-label" %>
                  <%= form.number_field :adults,
                        min: 1,
                        required: true,
                        class: "form-control" %>
                </div>

                <div class="col-md-6 mb-3">
                  <%= form.label :children, "Children", class: "form-label" %>
                  <%= form.number_field :children,
                        min: 0,
                        value: booking.children || 0,
                        required: true,
                        class: "form-control" %>
                </div>
              </div>
            </div>

            <!-- Status -->
            <div class="mb-4">
              <h5 class="mb-3">Booking Status</h5>
              <%= form.select :status,
                    Booking.statuses.keys - ["checked_in", "checked_out"],
                    {},
                    required: true,
                    class: "form-select" %>
            </div>

            <!-- Comment -->
            <div class="mb-4">
              <h5 class="mb-3">Internal Notes</h5>
              <%= form.text_area :comment,
                    rows: 3,
                    placeholder: "Add any special instructions or notes for this booking...",
                    class: "form-control" %>
            </div>


            <div class="d-grid">
              <%= form.submit "Save Booking",
                    class: "btn btn-primary btn-lg",
                    id: "save-booking-btn" %>
            </div>

          <% end %>
        </div>
      </div>
    </div>

    <!-- ================= RIGHT: INFO PANEL ================= -->
    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body">

          <h4 class="mb-4">Information</h4>

          <!-- Room History -->
          <div class="mb-4">
            <h6 class="text-muted">Room</h6>
            <h5 id="selected-room-name">None</h5>

            <div id="customer-history" class="mt-2">
              <p class="text-muted">No history yet</p>
            </div>
          </div>

          <hr>

          <!-- Customer Preview -->
          <div>
            <h6 class="text-muted">Selected Customer</h6>
            <div id="customer-preview" class="mt-2">
              <p class="text-muted">Select a customer to view details</p>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>
